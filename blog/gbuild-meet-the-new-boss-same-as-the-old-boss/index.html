<!DOCTYPE html>
<html lang="en">

<head>
  
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title></title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://bjoernmichaelsen.github.io/css/bootstrap.min.css">
  <!-- Custom fonts for this template -->
  <link href=" https://bjoernmichaelsen.github.io/css/all.min.css" rel=" stylesheet" type="text/css">
  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
    type='text/css'>
  <link
    href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
    rel='stylesheet' type='text/css'>

  <!-- Custom styles for this template -->
  <link rel="stylesheet" href="https://bjoernmichaelsen.github.io/clean-blog.css">

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="https:&#x2F;&#x2F;bjoernmichaelsen.github.io"></a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
        data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
        aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          
          <li class="nav-item">
            <a class="nav-link"
              href="https:&#x2F;&#x2F;bjoernmichaelsen.github.io">Home</a>
          </li>
          
          <li class="nav-item">
            <a class="nav-link"
              href="https:&#x2F;&#x2F;bjoernmichaelsen.github.io&#x2F;about">About</a>
          </li>
          
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Header -->
  
<!-- Page Header -->
<header class="masthead" style="background-image: url('https://bjoernmichaelsen.github.io/img/post-bg.jpg')">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <div class="post-heading">
          
<h1>gbuild: Meet the new boss (Same as the old boss)</h1>
<span class="meta">Posted by
    <a href="#">Bjoern Michaelsen</a>
    on 26 July 2011
</span>

        </div>
      </div>
    </div>
  </div>
</header>


  
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <h1 id="gbuild-meet-the-new-boss-same-as-the-old-boss">gbuild: Meet the new boss (Same as the old boss)</h1>
<blockquote><i>This is the fifth post in a short series of blog posts about the new GNU  make based build system that was integrated into the m96 milestone of the DEV300  codeline. It is covering gbuild commands and usage.</i><br /></blockquote>    <p>Welcome back to the&nbsp;little blog series about the new GNU make build system. After showing off <a href="http://planets.sun.com/GullFOSS/entry/gbuild_eyecandy_for_developers">some ANSI color eyecandy</a>  for the new build system it is time to have a look at the new build  system and how to command it in the usual usecases (all commands assume  the shell to be in root directory of the module in question, if no  explicit cd command is given):</p>    <p>&nbsp;</p>    <table cellspacing="0" cellpadding="1" border="0" style="width: 100%; background-color: rgb(153, 153, 204);" class=" htmtableborders">      <tbody>        <tr>          <td align="center" style="width: 25%; background-color: rgb(102, 102, 153);">build.pl/dmake</td>          <td align="center" style="width: 25%; background-color: rgb(102, 102, 153);">GNU make build system</td>          <td align="center" style="width: 25%; background-color: rgb(102, 102, 153);">description</td>        </tr>        <tr>          <td style="width: 25%;"><font face="courier new,courier,monospace">build &amp;&amp; deliver<br /></font></td>          <td style="width: 25%;"><font face="courier new,courier,monospace">make -sr<br /></font></td>          <td style="width: 25%;">builds the current module</td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(204, 204, 255);"><font face="courier new,courier,monospace">deliver -undeliver &amp;&amp; rm -rf $PLATFORM<br /></font></td>          <td style="width: 25%; background-color: rgb(204, 204, 255);"><font face="courier new,courier,monospace">make -sr clean<br /></font></td>          <td style="width: 25%; background-color: rgb(204, 204, 255);">clears the module from the $OUTDIR (solver) and clears local build directories</td>        </tr>        <tr>          <td valign="top"><font face="courier new,courier,monospace">build --all &amp;&amp; deliver<br /></font></td>          <td valign="top"><font face="courier new,courier,monospace">build --all <br /></font></td>          <td valign="top">&nbsp;</td>        </tr>        <tr>          <td valign="top" style="background-color: rgb(204, 204, 255);"><font face="courier new,courier,monospace">cd instsetoo_native &amp;&amp; build --all<br /></font></td>          <td valign="top" style="background-color: rgb(204, 204, 255);"><font face="courier new,courier,monospace">cd $SRC_ROOT &amp;&amp; make -sr<br /></font></td>          <td valign="top" style="background-color: rgb(204, 204, 255);">builds all</td>        </tr>        <tr>          <td style="vertical-align: top;"><font face="courier new,courier,monospace">cd instsetoo_native &amp;&amp; build --prepare --from sal<br /></font></td>          <td style="vertical-align: top;"><font face="courier new,courier,monospace">cd $SRC_ROOT &amp;&amp; make -sr clean<br /></font></td>          <td style="vertical-align: top;">clears all modules and all local build directories</td>        </tr>      </tbody>    </table>    <p><br />Some things changed from the old build system. Here is an overview:</p>    <h5>no local output tree</h5>    <p>The GNU make build system does not use a &quot;local module output directory&quot;. All modules use a <font face="courier new,courier,monospace">$WORKDIR</font> (by default a directory named &quot;workdir&quot; in the platform directory in the <font face="courier new,courier,monospace">$OUTDIR</font>/solver) for intermediate files. This makes the source tree read-only for the migrated modules.</p>    <h5>cleaning up of modules</h5>    <p><font face="courier new,courier,monospace">build --prepare</font> will not clear the <font face="courier new,courier,monospace">$WORKDIR</font> of files by migrated modules. However, calling <font face="courier new,courier,monospace">make -sr clean</font> in the module or in the <font face="courier new,courier,monospace">$SRC_ROOT</font> will.</p>    <h5>current directory when starting make</h5>    <p>Other than build.pl, one can not call <font face="courier new,courier,monospace">make</font> in any subdirectory  to build the module. Either, one has to <font face="courier new,courier,monospace">cd</font> to the module root before  calling make, or one has to explicitly give the makefile in the module  root to the make command: <font face="courier new,courier,monospace">cd sw/source/core &amp;&amp; make -srf  ../../Makefile</font>.</p>    <h5>changes in parallelization</h5>    <p>The old build system used one dmake process per directory, while the new  one is hooked into build.pl as one make process per module for now. Big modules like sw only  use the parallelization by the second -P switch given to the build --all  command. As more and more modules get migrated the second -P switch in a  <font face="courier new,courier,monospace">build --all -P4 -- -P4</font>  command will get more important. In the end -- after getting rid of  build.pl -- only one make process will be used for the whole build and  the maximum number of jobs will be given to via the <font face="courier new,courier,monospace">-j</font> switch, thus eliminating the need for guesswork on how to distribute the parallelization over the two old systems.</p>    <p>&nbsp;</p>    <h5>precompiled debug headers</h5>    <p>On Windows support for precompiled headers is also available on debug  builds, resulting for example in a speedup of ~40% for an build of  module sw for debug builds.</p>    <p>&nbsp;</p>    <h5>no seperation of build and deliver</h5>    <p>The new build system does not separate the build and deliver steps  of a module. Since libraries are always linked against the solver/<font face="courier new,courier,monospace">$OUTDIR</font>  this means that in module framework, where the library fwk is linking  against the library fwi, the library fwi will be copied to the solver/<font face="courier new,courier,monospace">$OUTDIR</font>  before linking the library fwk. This lifts the artificial dependency  barriers introduced by modules, but also results in that building a  module always modifies the solver/<font face="courier new,courier,monospace">$OUTDIR</font>. It also avoids the confusion of building a module, but forgetting to deliver it.</p>    <h5>no local module builds</h5>    <p>One can not simply copy a module to &quot;anywhere&quot; and build it there.  The build system will notice this and will bail out. And even when it  would not bail out, it would ignore the copied module for anything but  the makefiles. It would still look for the files to build and to compile  in the directories given in the variable <font face="courier new,courier,monospace">$gb_REPOS</font> as described in the post about multiple repository support.</p>    <p>To provide a workaround for the rare usecase that one wants to  build only one module with some quick or risky changes without changing  the solver, there is a setuplocal target available in gbuild. For example to do experimental stuff on the tools module one would:</p>    <blockquote>      <p><font face="courier new,courier,monospace">export gb_LOCALBUILDDIR=/tmp/myoootoolsexperiment</font></p>      <p><font face="courier new,courier,monospace">cd tools</font></p>      <p><font face="courier new,courier,monospace">make setuplocal # this  will create a copy of the tools module and the solver at  $gb_LOCALBUILDDIR and tune the build system to that location<br /></font></p>      <p><font face="courier new,courier,monospace">cd /tmp/myoootoolsexperiment/srcdir/tools</font></p>      <p><font face="courier new,courier,monospace"># hack away</font></p>      <p><font face="courier new,courier,monospace">cd $SRC_ROOT/tools</font></p>      <p><font face="courier new,courier,monospace">make removelocal # clears $gb_LOCALBUILDDIR and allows work directly on the source</font></p>    </blockquote>    <p>This is an extension to the gbuild system (because it relies on rsync, which the gbuild core itself should not do) and thus can be found in <a href="http://hg.services.openoffice.org/cws/gnumake2/file/2b1c7f39e6d4/solenv/gbuild/extensions/SetupLocal.mk">the extensions directory of the build system</a>.</p>    <h5>full dependencies</h5>    <p>Migrated modules always have full dependencies thus changing one  header in a low level module will trigger a rebuild of all objects using  that header. On Windows that means all headers except compiler headers  and headers from platform, directx and Java SDK, on the other platforms  it means all headers.</p>    <h5>Faster no-op builds</h5>    Checking that nothing (or almost nothing) needs to be rebuild is  faster. On a sample system (Notebook with Core2Duo, 2 GHz) on Windows XP  (anti virus software installed), rechecking that nothing needs to be  done for module sw takes 7 sec with a warm cache. On the same machine  build.pl/dmake took 210 sec with the same &quot;full&quot; header dependencies.<br /><br />(This is a very raw mirror of the original blog post made to blogs.sun.com  on 21 Dec 2010. As per <a href="http://web.archive.org/web/20090627144253/http://www.sun.com/termsofuse.jsp" rel="nofollow">http://web.archive.org/web/2009062714425<wbr></wbr>3/http://www.sun.com/termsofuse.jsp </a>   &quot;... You grant Sun and all other users of the Website an irrevocable,   worldwide, royalty-free, nonexclusive license to use, reproduce,  modify,  distribute, transmit, display, perform, adapt, resell and  publish such  Content (including in digital form) ...&quot; )
<p>This was originally published at 2011-07-26 10:30:00/2011-07-26 08:30:12 on <a href="https://sweetshark.livejournal.com/3188.html">livejournal</a>.</p>

        
      </div>
    </div>
  </div>
</article>


  <hr>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            <li class="list-inline-item">
              <a href="https:&#x2F;&#x2F;bjoernmichaelsen.github.io&#x2F;rss.xml">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            
          </ul>
          <p class="copyright text-muted">Copyright &copy; Bjoern Michaelsen
            2022</p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap core JavaScript -->
  <script src="https://bjoernmichaelsen.github.io/js/jquery.min.js"></script>
  <script src="https://bjoernmichaelsen.github.io/js/bootstrap.bundle.min.js"></script>

  <!--Custom scripts for this template-->
  <script src="https://bjoernmichaelsen.github.io/js/clean-blog.min.js"></script>

  <!--- Additional scripts -->
  
  
</body>

</html>
