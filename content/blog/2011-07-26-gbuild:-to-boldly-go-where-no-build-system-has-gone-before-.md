+++
title="gbuild: To boldly go where no build system has gone before ..."
date=2011-07-26
[taxonomies]
originally-published-on=["livejournal"]
+++
gbuild: To boldly go where no build system has gone before ...
==============================================================

> <p><i>This is the first post in a short series of blog&nbsp;posts about the new GNU  make based build system that will soon be integrated into the DEV300  codeline. It is covering the memory usage of the new GNU make build  system when using full dependencies.</i></p>
<p>Since the <a href="http://192.9.162.56/GullFOSS/entry/building_openoffice_org_with_gnu">first announcement</a>  of plans to replace the old build.pl/dmake build system with a new  solution, one of the focus points was the correct handling of  dependencies. To handle this problem correctly, multiple approaches have  been tried and one was to have all dependencies in one process because <a href="http://miller.emu.id.au/pmiller/books/rmch/">recursive make is considered harmful</a>. As the <a href="http://hg.services.openoffice.org/cws/gnumake2">gnumake2 cws</a>  is finally approaching the final status in the lifecycle of a feature  branch (being &quot;ready for QA&quot; until &quot;integrated&quot;), it is time to address  one of the main concerns reported by community members about it: memory  usage.</p>    <p>The very idea of having all information about an OpenOffice.org  build in one process -- including all dependencies -- might sound  obnoxious and  megalomaniac at first. But in general, memory got cheap in recent years  and it was the time to at least consider this option.</p>    <p>By now, we can say it was well worth it: gnumake2 is now capable of  building eight modules (framework, sfx2, svl, svtools, sw, toolkit,  tools, xmloff) in one process, and we have a solid base to approximate  the memory usage of a build that contains all dependencies in one  process.</p>    <p>First we have to find a reasonable metric of &quot;dependency-intensity&quot;  of a part of the build. Then we can try to relate that metric to the  memory usage measured on migrated modules to extrapolate to a full  build.</p>    <p>A simple metric is the number on #include-statements in hxx- and  cxx-files. (That might be a very na&iuml;ve assumption, but I have spent too  much lifetime in the physics department of a university to be scared of a  <a href="http://en.wikipedia.org/wiki/Spherical_cow">spherical cow</a>.)</p>    <p>To measure the memory usage two methods have been used:</p>    <ol><li>Adding <font size="4" face="courier new,courier,monospace">$(info finished parsing.) $(shell sleep 60)</font> to the end of the main makefile allowed me to measure the heap size of a real make process with <font size="4" face="courier new,courier,monospace">pmap -d $(ps -a|grep make|cut -f1 -d\ )|egrep -o writeable/private:.[0-9]+K|cut -f 2 -d\ </font>on Linux 64-Bit.</li><li><a href="http://valgrind.org/docs/manual/ms-manual.html">valgrinds massif</a> provided a simple, but synthetic way to do the same (using useful-heap as a measure).</li></ol>    <table cellspacing="0" cellpadding="1" border="0" style="width: 100%; display: table;" class=" htmtableborders">      <tbody>        <tr>          <td style="width: 25%; background-color: rgb(102, 102, 153);">&nbsp;</td>          <td align="right" style="width: 25%; background-color: rgb(102, 102, 153);">&nbsp;include statements</td>          <td align="right" style="width: 25%; background-color: rgb(102, 102, 153);">pmap (KiB)</td>          <td align="right" style="width: 25%; background-color: rgb(102, 102, 153);">&nbsp;massif (KiB)</td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(153, 153, 204);">&nbsp;no module</td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;0</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;632</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace"> 407<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(204, 204, 255);">&nbsp;tools</td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;964</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;1184</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace"> 1115<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(153, 153, 204);">&nbsp;svl</td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;1652</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;1660</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace"> 1645<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(204, 204, 255);">&nbsp;toolkit</td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;2276</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;3524</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace"> 3210<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(153, 153, 204);">&nbsp;svtools</td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;3768</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;5548</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace"> 5179<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(204, 204, 255);">&nbsp;framework</td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;6049</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;5188</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace"> 4812<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(153, 153, 204);">&nbsp;sfx2</td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;6065</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;6196</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace"> 5961<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(204, 204, 255);">&nbsp;xmloff</td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;6496</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;6860</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace"> 6582<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(153, 153, 204);">&nbsp;framework, sfx2</td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;12514</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;10276</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace"> 9276<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(204, 204, 255);">&nbsp;sw</td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;24087</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;29340</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace"> 25943<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(153, 153, 204);">&nbsp;all migrated but sw</td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;27670</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;23124</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace"> 21145<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(204, 204, 255);">&nbsp;all migrated but xmloff, sfx2</td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;38796</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace">&nbsp;40088</font></td>          <td align="right" style="width: 25%; background-color: rgb(204, 204, 255);"><font size="4" face="courier new,courier,monospace"> 35550<br /></font></td>        </tr>        <tr>          <td style="width: 25%; background-color: rgb(153, 153, 204);">&nbsp;all migrated</td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;51757</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace">&nbsp;50812</font></td>          <td align="right" style="width: 25%; background-color: rgb(153, 153, 204);"><font size="4" face="courier new,courier,monospace"> 45129<br /></font></td>        </tr>      </tbody>    </table>    <p>&nbsp;</p>    <p>Using a simple linear regression over the data, OpenOffice.org Calcs <font face="courier new,courier,monospace">LINEST</font>  function tells me that one can assume a heap usage of 1010&plusmn;40 bytes per  include for the pmap data and 890&plusmn;35 bytes for the massif data. This  plot show no obvious systematic error in the assumption of the model:</p>

![gbuild scaling chart](/img/lj/2011-07-26-gbuildmem.png)


<p>&nbsp;</p>      <p>The last two data points are the predictions of the model for a full build with and without binfilter:</p>      <ul><li>without binfilter: 170-190 MiB (pmap), 150-170 MiB (massif)</li><li>with binfilter: 190-210 MiB (pmap), 170-180 MiB (massif)</li></ul>So it can be assumed that a full build with all dependencies  can be handled decently even by slower and smaller hardware as even  common ARM machines have enough RAM to handle this.<br />      <p>Finishing note: gnumake2 will be integrated soon, so if you are using  actively developing on the DEV300 codeline, it is advisable to check  out the basics of it. A good starting point is the talk <a href="http://www.ooocon.org/index.php/ooocon/2010/paper/view/212">&quot;Rebooting the OpenOffice.org Build System&quot;</a> [ <a href="http://wiki.services.openoffice.org/w/images/0/03/RebootingBuild.odp">ODP</a> <a href="http://www.ooocon.org/index.php/ooocon/2010/paper/view/212/188">PDF</a> <a href="http://users2.ooodev.org/%7Eooocon2010/01_september/FT_309/14.00_bj%f6rn_m_rebooting_the_openoffice.org_build_system.flv">video</a> ] I gave at the OOoCon2010. For more detailed information see the <a href="http://wiki.services.openoffice.org/wiki/Build_Environment_Effort">Build Environment Effort section</a> at the OOo wiki.</p>      <p>I hope to keep the posts about the build system coming in the next days. Next up: <a href="http://blogs.sun.com/GullFOSS/entry/gbuild_how_to_migrate_a">How to migrate a module to gbuild</a>.</p>      <p>&nbsp;</p>      <p>P.S.: In case an interested GNU make hacker comes across this post, here is some output from <font face="courier new,courier,monospace">make -p</font> for the 8 migrated modules:</p><font face="courier new,courier,monospace">2385 variable set hash-tables<br /># files hash-table stats:<br /># Load=21210/32768=65%, Rehash=5, Collisions=605939/1022290=59%<br /><br /><br /># # of strings in strcache: 32753 / lookups = 991181 / hits = 958428<br /># # of strcache buffers: 284 (* 8176 B/buffer = 2321984 B)<br /># strcache used: total = 2313570 (5196) / max = 8176 / min = 8170 / avg = 8175 <br /># strcache free: total = 238 (2980) / max = 6 / min = 0 / avg = 0<br /><br /># strcache hash-table stats:<br /># Load=32869/65536=50%, Rehash=3, Collisions=545530/1044947=52%</font><br /><br />(This is a very raw mirror of the original blog post made to blogs.sun.com  16 Nov 2010. As per <a href="http://web.archive.org/web/20090627144253/http://www.sun.com/termsofuse.jsp ">http://web.archive.org/web/20090627144253/http://www.sun.com/termsofuse.jsp </a> &quot;... You grant Sun and all other users of the Website an irrevocable, worldwide, royalty-free, nonexclusive license to use, reproduce, modify, distribute, transmit, display, perform, adapt, resell and publish such Content (including in digital form) ...&quot; )

This was originally published at 2011-07-26 10:03:00/2011-07-26 08:03:08 on [livejournal](https://sweetshark.livejournal.com/2517.html).
