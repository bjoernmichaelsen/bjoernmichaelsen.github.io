+++
title="gbuild: How to setup a repository"
date=2011-07-26
[taxonomies]
originally-published-on=["livejournal"]
+++
gbuild: How to setup a repository
=================================

<blockquote>      <p><i>This is the third post in a short series of blog posts about the new GNU  make based build system that will soon be integrated into the DEV300  codeline. It is covering how to use the multi repository support of gbuild.</i></p>    </blockquote>    <p>Welcome back to the&nbsp;little blog series about the new GNU make build system. <a href="http://192.9.162.56/GullFOSS/entry/gbuild_how_to_migrate_a">After having covered the setup of a module in the gbuild system in the last post</a>, this one will be about how repositories are setup with gbuild. A repository in gbuild is a directory where source files are found. While OpenOffice.org currently has every source file in one big repository, gbuild supports to have multiple repositories and will find a file in any of those.</p>    <h3>Making repositories known to gbuild</h3>    <p>gbuild needs to be told about the repositories it should look for source files. This is done with the variable <font face="courier new,courier,monospace">gb_REPOS</font> which contains a whitespace separated list of source directories. For backwards compatibility, if <font face="courier new,courier,monospace">gb_REPOS</font> is not set, <a href="http://hg.services.openoffice.org/cws/gnumake2/file/tip/solenv/gbuild/BuildDirs.mk#l39">it defaults to <font face="courier new,courier,monospace">$(SOLARSRC)</font> for now</a> (we might get rid of that one day and set <font face="courier new,courier,monospace">gb_REPOS</font> in ./configure along with <font face="courier new,courier,monospace">SOLARSRC</font>).</p>    <h3>Setting up a repository for gbuild</h3>    <p>Three files need to be present in the root of a gbuild repository:</p>    <ul><li><font face="courier new,courier,monospace">Repository.mk</font></li><li><font face="courier new,courier,monospace">RepositoryFixes.mk</font></li><li>and <font face="courier new,courier,monospace">Module_*.mk</font></li></ul>    <p>In Repository.mk  we define some things that need to be globally known for the build. The  first thing that needs to be globally set is a variable name for this repository, so that we can refer to it -- for example when defining include paths. This is done by a <a href="http://hg.services.openoffice.org/cws/gnumake2/file/tip/Repository.mk#l28">statement like this</a>:</p>    <p>&nbsp;</p>    <blockquote>      <p style="background-color: rgb(210, 210, 210);"><font face="courier new,courier,monospace" style="background-color: rgb(210, 210, 210);">$(eval $(call gb_Helper_register_repository,SRCDIR))</font></p>    </blockquote>    <p>Because of this statement the OpenOffice.org source repository can be referenced as <font face="courier new,courier,monospace">$(SRCDIR)</font> when defining include paths. Other repositories should obviously use a different variable name for their directory.</p>    <p>In addition, we need to declare the naming scheme and the layer  that libraries and executables end up in the final product. With <a href="http://hg.services.openoffice.org/cws/gnumake2/file/tip/Repository.mk#l41">the statement</a>:</p>    <blockquote style="background-color: rgb(210, 210, 210);">      <p><font face="courier new,courier,monospace" style="background-color: rgb(210, 210, 210);">$(eval $(call</font><font face="courier new,courier,monospace"> gb_Helper_register_libraries,OOOLIBS, [...] fwk [...] sw [...] </font><font face="courier new,courier,monospace" style="background-color: rgb(210, 210, 210);">))</font></p>    </blockquote>    <p>We register the libraries &quot;fwk&quot; and &quot;sw&quot; to be &quot;OOOLIBS&quot;. What this  means exactly depends on the platform, but on Linux 64-Bit for example  it means that the libraries are named &quot;libfwklx.so&quot; and &quot;libswlx.so&quot; and  will end up in the OpenOffice.org layer of the product. This  information needs to be declared globally in the repository and can not be simply declared in the local files in the modules like <font face="courier new,courier,monospace">framework/Library_fwk.mk</font>  : When one does a partial build (only one module, e.g. sw) that  information is still needed, because the filenames of the linked-against  libraries need to be known. On OSX, additionally the exact location of  the linked-against library (and thus its layer) needs to be known at  linktime.</p>    <p>The second file <font face="courier new,courier,monospace">RepositoryFixes.mk</font>  is to fix for those cases where developers got too creative for their  own good and followed a naming scheme only mostly: naming it slightly  different on one platform, for example. When gbuild starts up, it parses the <font face="courier new,courier,monospace">Repository.mk</font> in each repository.&nbsp; Then it loads the platform defaults and assigns the names and layers according to it. After that the <font face="courier new,courier,monospace">RepositoryFixes.mk</font> file in each repository  gets parsed and can fix around &quot;special cases&quot;. It should contain all  the hacks that work around things that break the usual systematics.</p>    <p>The final file is the <font face="courier new,courier,monospace">Module_*.mk</font>. In the case of the OpenOffice.org repository this is the <a href="http://hg.services.openoffice.org/cws/gnumake2/file/tip/Module_ooo.mk"><font face="courier new,courier,monospace">Module_ooo.mk</font></a> file. When everything is migrated to gbuild,  one will not build module-by-module, but with one make process. This  make process will finally, after parsing all other setup code, go into  each repository it find in <font face="courier new,courier,monospace">gb_REPOS</font> and include the one <font face="courier new,courier,monospace">Module_*.mk</font> file it finds there. After parsing those module files, <a href="http://hg.services.openoffice.org/cws/gnumake2/file/tip/GNUmakefile#l35">the modules in each of those are added as dependencies to the <font face="courier new,courier,monospace">all</font> target</a> -- they need to be built and it turn ensure all modules that are part of it to be built. Gbuild modules can include other modules (yes, you can build &quot;module trees&quot; of arbitrary depth). <font face="courier new,courier,monospace">Module_ooo.mk</font> is just a module that includes all migrated modules.</p>    Ok, enough already of this dry and rather boring topic. The next post will be about <a href="http://192.9.162.56/GullFOSS/entry/gbuild_eyecandy_for_developers">eyecandy for developers</a>.<br /><br />(This is a very raw mirror of the original blog post made to blogs.sun.com  on 23 Nov 2010. As per <a href="http://web.archive.org/web/20090627144253/http://www.sun.com/termsofuse.jsp" rel="nofollow">http://web.archive.org/web/2009062714425<wbr></wbr>3/http://www.sun.com/termsofuse.jsp </a>  &quot;... You grant Sun and all other users of the Website an irrevocable,  worldwide, royalty-free, nonexclusive license to use, reproduce, modify,  distribute, transmit, display, perform, adapt, resell and publish such  Content (including in digital form) ...&quot; )

This was originally published at 2011-07-26 10:16:00/2011-07-26 08:16:40 on [livejournal](https://sweetshark.livejournal.com/2801.html).
